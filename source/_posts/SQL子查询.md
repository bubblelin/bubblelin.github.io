---
title: SQL子查询基于MySQL
date: 2016-09-03 21:42:42
categories: 数据库  
tags: [SQL]
---

### 什么是子查询

子查询也叫嵌套查询，一个查询语句嵌套在另一个查询语句中，内层查询的结果可以作为外层查询条件，或者可以看成临时表。一般的，嵌套在`where` 或者 `from`子句中。

多表连接查询过程：
- 两张表做笛卡尔积；
- 筛选匹配条件的数据记录
- 若笛卡尔积记录数比较大，可能造成服务器崩溃


Example Tables：商品表和商品分类表

```SQL

mysql> select * from product;
+----+----------------+--------+-----------+----------+-------+--------+-----------+
| id | productName    | dir_id | salePrice | supplier | brand | cutoff | costPrice |
+----+----------------+--------+-----------+----------+-------+--------+-----------+
|  1 | 罗技M90        |      3 |        90 | 罗技     | 罗技  |    0.5 |        35 |
|  2 | 罗技M100       |      3 |        49 | 罗技     | 罗技  |    0.9 |        33 |
|  3 | 罗技M115       |      3 |        99 | 罗技     | 罗技  |    0.6 |        38 |
|  4 | 罗技M125       |      3 |        80 | 罗技     | 罗技  |    0.9 |        39 |
|  5 | 罗技木星轨迹球  |      3 |       182 | 罗技     | 罗技  |    0.8 |        80 |
|  6 | 罗技火星轨迹球  |      3 |       349 | 罗技     | 罗技  |   0.87 |       290 |
|  7 | 罗技G9X        |      3 |       680 | 罗技     | 罗技  |    0.7 |       470 |
|  8 | 罗技M215       |      2 |        89 | 罗技     | 罗技  |   0.79 |        30 |
|  9 | 罗技M305       |      2 |       119 | 罗技     | 罗技  |   0.82 |        48 |
| 10 | 罗技M310       |      2 |       135 | 罗技     | 罗技  |   0.92 |      69.8 |
| 11 | 罗技M505       |      2 |       148 | 罗技     | 罗技  |   0.92 |        72 |
| 12 | 罗技M555       |      2 |       275 | 罗技     | 罗技  |   0.88 |       140 |
| 13 | 罗技M905       |      2 |       458 | 罗技     | 罗技  |   0.88 |       270 |
| 14 | 罗技MX1100     |      2 |       550 | 罗技     | 罗技  |   0.76 |       300 |
| 15 | 罗技M950       |      2 |       678 | 罗技     | 罗技  |   0.78 |       320 |
| 16 | 罗技MX Air     |      2 |      1299 | 罗技     | 罗技  |   0.72 |       400 |
| 17 | 罗技G1         |      4 |       155 | 罗技     | 罗技  |    0.8 |        49 |
| 18 | 罗技G3         |      4 |       229 | 罗技     | 罗技  |   0.77 |        96 |
| 19 | 罗技G500       |      4 |       399 | 罗技     | 罗技  |   0.88 |       130 |
| 20 | 罗技G700       |      4 |       699 | 罗技     | 罗技  |   0.79 |       278 |
+----+----------------+--------+-----------+----------+-------+--------+-----------+
```

```SQL
mysql> select * from productdir;
+----+----------+-----------+
| id | dirName  | parent_id |
+----+----------+-----------+
|  1 | 鼠标     | NULL      |
|  2 | 无线鼠标 |         1 |
|  3 | 有线鼠标 |         1 |
|  4 | 游戏鼠标 |         1 |
+----+----------+-----------+
```

### 子查询之单行单例查询

子查询的结果（临时表），返回的是只有一行，且只有一列的数据，提供作外表查询的条件
- 需求：查询零售价比‘罗技G90X’更高的商品信息。

- sql语句
```SQL
select
  *
from
  product
where
  salePrice > (
    select
      salePrice
    from
      product
    where
      productName = '罗技G9X'
  );
```
- 查询结果
```SQL
+----+-------------+--------+-----------+----------+-------+--------+-----------+
| id | productName | dir_id | salePrice | supplier | brand | cutoff | costPrice |
+----+-------------+--------+-----------+----------+-------+--------+-----------+
| 16 | 罗技MX Air  |      2 |      1299 | 罗技     | 罗技  |   0.72 |       400 |
| 20 | 罗技G700    |      4 |       699 | 罗技     | 罗技  |   0.79 |       278 |
+----+-------------+--------+-----------+----------+-------+--------+-----------+
```

### 子查询之单行多例查询

子查询的结果（临时表），返回的是只有一行，但是有多列的数据，提供作外表查询的条件
- 需求：查询分类编号和折扣与‘罗技M100’相同的的商品信息。

- sql语句
```SQL
select
  p.*
from
  product p
where
  (p.dir_id,p.cutoff)=(
    select
      p.dir_id,p.cutoff
    from
      roduct p
    where
      productName = '罗技M100'
  );
```

- 查询结果
```SQL
+----+-------------+--------+-----------+----------+-------+--------+-----------+
| id | productName | dir_id | salePrice | supplier | brand | cutoff | costPrice |
+----+-------------+--------+-----------+----------+-------+--------+-----------+
|  2 | 罗技M100    |      3 |        49 | 罗技     | 罗技  |    0.9 |        33 |
|  4 | 罗技M125    |      3 |        80 | 罗技     | 罗技  |    0.9 |        39 |
+----+-------------+--------+-----------+----------+-------+--------+-----------+
```

### 子查询之多行多例查询

- 需求：查询各商品的分类的分类编号，分类名称，商品数量，平均价格

- sql语句
```SQL
select
  pd.id,pd.dirName,temp.CountNum,temp.avgPrice
from
  productdir pd
join
(
  select
    p.dir_id tId, count(p.id) countNum, avg(p.salePrice) avgPrice
  from
    product p
  group by
    p.dir_id
)
  temp
on
  pd.id = temp.tId;
```

- 查询结果
```SQL
+----+----------+----------+------------+
| id | dirName  | CountNum | avgPrice   |
+----+----------+----------+------------+
|  2 | 无线鼠标 |        9 | 416.777778 |
|  3 | 有线鼠标 |        7 | 218.428571 |
|  4 | 游戏鼠标 |        4 |      370.5 |
+----+----------+----------+------------+
```
